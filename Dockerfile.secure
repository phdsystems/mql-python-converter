FROM ubuntu:22.04

# Build arguments for non-root user
ARG USER_ID=1000
ARG GROUP_ID=1000
ARG USERNAME=developer

ENV DEBIAN_FRONTEND=noninteractive
ENV DISPLAY=:1
ENV VNC_PORT=5901
ENV NOVNC_PORT=6080
ENV VNC_PASSWORD=mt4vnc
ENV WINE_MONO_VERSION=7.4.0
ENV WINE_GECKO_VERSION=2.47.3
ENV PYTHONUNBUFFERED=1

# Install required packages
RUN apt-get update && apt-get install -y \
    wget \
    software-properties-common \
    gnupg2 \
    xvfb \
    x11vnc \
    novnc \
    websockify \
    supervisor \
    fluxbox \
    xterm \
    net-tools \
    curl \
    vim \
    python3 \
    python3-dev \
    git \
    build-essential \
    sudo \
    && dpkg --add-architecture i386 \
    && wget -qO- https://dl.winehq.org/wine-builds/winehq.key | apt-key add - \
    && add-apt-repository 'deb https://dl.winehq.org/wine-builds/ubuntu/ jammy main' \
    && apt-get update \
    && apt-get install -y --install-recommends winehq-stable \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user with specific UID/GID for consistency
RUN groupadd -g ${GROUP_ID} ${USERNAME} \
    && useradd -m -u ${USER_ID} -g ${GROUP_ID} -s /bin/bash ${USERNAME} \
    && echo "${USERNAME}:${USERNAME}" | chpasswd

# Grant specific sudo permissions only for required commands (if needed)
# For production, remove sudo entirely
RUN echo "${USERNAME} ALL=(ALL) NOPASSWD: /usr/bin/supervisorctl" >> /etc/sudoers.d/${USERNAME} \
    && chmod 0440 /etc/sudoers.d/${USERNAME}

# Create application directories with proper ownership
RUN mkdir -p /app/converter \
    && mkdir -p /app/mt4-terminal \
    && mkdir -p /app/logs \
    && mkdir -p /app/data \
    && mkdir -p /home/${USERNAME}/.vnc \
    && mkdir -p /home/${USERNAME}/.wine \
    && mkdir -p /var/run/supervisor \
    && chown -R ${USERNAME}:${USERNAME} /app \
    && chown -R ${USERNAME}:${USERNAME} /home/${USERNAME} \
    && chown -R ${USERNAME}:${USERNAME} /var/run/supervisor

# Setup VNC password as non-root user
USER ${USERNAME}
RUN x11vnc -storepasswd ${VNC_PASSWORD} /home/${USERNAME}/.vnc/passwd

# Setup noVNC (as root for system install, then set permissions)
USER root
RUN ln -s /usr/share/novnc/vnc.html /usr/share/novnc/index.html \
    && chown -R ${USERNAME}:${USERNAME} /usr/share/novnc

# Copy application files with proper ownership
WORKDIR /app/converter
COPY --chown=${USER_ID}:${GROUP_ID} . .

# Install uv package manager as root
USER root
RUN curl -LsSf https://astral.sh/uv/install.sh | INSTALLER_NO_MODIFY_PATH=1 sh -s -- --to /usr/local/bin

# Copy project files for dependency installation
COPY --chown=${USER_ID}:${GROUP_ID} pyproject.toml /app/converter/
COPY --chown=${USER_ID}:${GROUP_ID} src /app/converter/src/

# Install Python dependencies as non-root user
USER ${USERNAME}
RUN cd /app/converter && \
    /usr/local/bin/uv venv .venv && \
    . .venv/bin/activate && \
    /usr/local/bin/uv pip install -e .

# Set Python environment
ENV PATH="/app/converter/.venv/bin:$PATH"
ENV VIRTUAL_ENV=/app/converter/.venv

# Copy configuration files
COPY --chown=${USER_ID}:${GROUP_ID} startup.sh /app/
COPY --chown=${USER_ID}:${GROUP_ID} supervisord-secure.conf /home/${USERNAME}/supervisord.conf
RUN chmod +x /app/startup.sh

# Configure Wine prefix as appuser
RUN winecfg -v win10 \
    && wineboot --init \
    && mkdir -p "/home/${USERNAME}/.wine/drive_c/Program Files (x86)"

# Set working directory
WORKDIR /app/converter

# Expose ports (>1024 for non-root binding)
EXPOSE 5901
EXPOSE 6080
EXPOSE 8000
EXPOSE 9090

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:6080/ || exit 1

# Run as non-root user
USER ${USERNAME}

# Start supervisor as non-root
CMD ["/usr/bin/supervisord", "-n", "-c", "/home/${USERNAME}/supervisord.conf"]